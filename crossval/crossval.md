# Кроссвалидация при оценке погрешности структурных построений 

**Введение**

Рассмотрено использование кроссвалидации в задаче оценки погрешности структурных построений. В "Рекомендациях по использованию материалов сейсморазведки при подсчете запасов" предложено использовать кроссвалидацию, как один из инструментов. Ниже приведены примеры  кроссвалидации для случаев когда данные не коррелированы в пространстве, и для случая коррелированных данных.
Традиционно ля получения карты глубин выполняется следующий порядок действий. Сначала выбирается модель прогноза глубины (например средняя скорость или регрессия времён-глубин),  с использованием такой модели выполняется расчет прогнозной карты глубины (Hpredict). Эта прогнозная карта не точно воспроизводит глубины в точках скважин - в точке каждой скважине есть невязка (error). Получение окончательной структурной карты подразумевает интерполяцию всех невязок и сложение их с прогнозной картой глубин (Htrue=Hpredict+error). Наиболее простым способом является оценка погрешности как величины стандартного отклонения по набору errori (где i это номер скважины).
Альтернативной такому способу является кроссвалидация. При выполнении этапа " интерполяцию всех невязок" можно исключить одну скважину. Эта скважина будет проверочной. После того, как построена интерполяция нужно воспроизвести значение в проверочной точке. Разницу между истинным значением невязки и тем как его восстановила интерполяция запишем отдельно, как ошибку кроссвалидации. В качестве проверочных скважины должны побывать все скважины.  В конце концов получим набор ошибок кроссвалидации и по ним вычислим стандартное отклонение.
Ниже показано, что второй способ не корректно использовать как меру погрешности структурных построений.

**Последовательность вычислений**

1. Подготовка набора ошибок прогноза глубин - N точек с координатами X и Y и величиной ошибки Z

1. Выполнение кроссвалидации. 

    - исключение одной точки

    - построение интерполяции по N-1 точкам

    - вычисление значения Z в исключенной точке delta=Ztrue-Zinterp

1. Получение оценки погрешности ( RMS value) по найденному набору значений delta

### Необходимые функции. 2D интерполяция

Ключевым этапом вычислений является построение интерполяции по данным. Здесь используется функция сплайн интерполяции из репозиторий функций Wolfram.

```mathematica
ResourceFunction["PolyharmonicSplineInterpolation"]
```

**Случай некоррелированных ошибок**

#### Подготовка данных

Входные данные представляют  50 точек со случайными значениями координат, эти  точки имитируют 50 скважин. В качестве координаты Z будут выступать невязки (error), заданы случайно по нормальному закону со стандартным отклонением заданным переменной sigma.
Фрагмент кода ниже выводит эти точки в виде фрагмента таблицы и в виде гистограммы.

```mathematica
n = 50;
sigma = 20; 
 
xyz = Transpose[{RandomReal[{0, 100}, n], RandomReal[{0, 100}, n], RandomVariate[NormalDistribution[0, sigma], n]}]; 
 
TableForm[Round[xyz[[1 ;; 10]], 0.1], TableHeadings -> {None, {"x", "y", "z"}}]
Histogram[xyz[[All, 3]], {-70, 70, 10}, Frame -> True, ImageSize -> 400, PlotLabel -> "Error distribution", LabelStyle -> Directive[11, Bold, Black]]
```

![фрагмент таблицы](crossval\img\cv01.png)

![гистограмма невязок]((crossval\img\cv02.png))

#### Кроссвалидация

Сначала выполним  интерполяцию, восстановим значения в каждой точке площади и отобразим их на графике.

```mathematica
f = ResourceFunction["PolyharmonicSplineInterpolation"][xyz];
```

```mathematica
Show[
  DiscretePlot3D[f[x, y], {x, 0, 100, 1}, {y, 0, 100, 1}, Filling -> None, Joined -> True, ColorFunction -> Hue], 
  ListPointPlot3D[xyz, PlotRange -> All, PlotStyle -> Black] 
 ]
```

![результат интерполяции]((crossval\img\cv03.png))

Следующий фрагмент кода выполняет собственно кроссвалидацию.
С помощью функции Table выполняется цикл, в котором итератор  задан от 1 до 50 (Length[xyz]).На каждом шаге исключается проверочная скважина, строится функция интерполяции, восстанавливается значение в проверочной точке. 

Функция StandardDeviation позволяет получить оценки
	как исходного набора невязок StandardDeviation[errors[[All,1]]]
	так и по ошибкам кроссвалидации StandardDeviation[errors[[All,1]]-errors[[All,2]]]

```mathematica
errors = Table[
   	Clear[if]; 
   	tmp = Delete[xyz, i]; 
   	if = ResourceFunction["PolyharmonicSplineInterpolation"][tmp]; 
   	{xyz[[i, 3]], if[xyz[[i, 1]], xyz[[i, 2]]]}, 
    {i, 1, Length[xyz]}];
```

```mathematica
TableForm[Round[{StandardDeviation[errors[[All, 1]]], StandardDeviation[errors[[All, 1]] - errors[[All, 2]]]}, 0.1], TableHeadings -> {{"RMS error initial", "RMS error cross"}, None}]
```

![сопоставление стандарных отклонений]((crossval\img\cv04.png))

Выведенная таблица  показывает схожий уровень стандарных отклонений. Т.е. нужно сделать вывод, что в случае невязок заданных случайно оценки по обоим способам дают схожий результат.

**Случай коррелированных ошибок**

### Необходимые функции. Генерация коррелированных данных

**Выводы**

**Ссылки**

Кроссвалидация
Методические рекомендациии
Репозиторий функций Wolfram